<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library</title>
    <style>
        :root {
            --bg: #0b1220;
            --panel: #121a2b;
            --card: #151f34;
            --muted: #8aa0c2;
            --text: #e8eefb;
            --accent: #6aa9ff;
            --accent-2: #22d3ee;
            --danger: #ef4444;
            --warning: #eab308;
            --success: #22c55e;
            --border: #22304a;
        }
        * { box-sizing: border-box; }
        body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: linear-gradient(180deg, #0b1220, #0b1220 60%, #0e1629); color: var(--text); }
        a { color: var(--accent); text-decoration: none; }
        header { position: sticky; top: 0; z-index: 10; background: rgba(10,16,30,.7); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); }
        .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand .logo { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 10px; box-shadow: 0 6px 20px rgba(34,211,238,.2); }
        .brand h1 { font-size: 18px; margin: 0; letter-spacing: .3px; }
        nav { display: flex; gap: 8px; flex-wrap: wrap; }
        .tabs { display: flex; gap: 8px; }
        .tab { padding: 8px 12px; border: 1px solid var(--border); background: #0f1729; color: var(--muted); border-radius: 8px; cursor: pointer; transition: .15s ease; }
        .tab:hover { color: var(--text); border-color: #2a3a5a; }
        .tab.active { background: linear-gradient(180deg, #15203a, #0f1729); color: var(--text); border-color: #34507c; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02), 0 6px 18px rgba(6,12,23,.35); }
        .shell { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 16px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .card { border: 1px solid var(--border); background: linear-gradient(180deg, #0e1526, #0c1424); border-radius: 12px; padding: 16px; box-shadow: 0 6px 24px rgba(6,12,23,.35); }
        .card h3 { margin-top: 0; }
        .muted { color: var(--muted); }
        label { display: block; font-weight: 600; margin-top: 8px; color: #c7d6f4; font-size: 12px; text-transform: uppercase; letter-spacing: .5px; }
        input, select { width: 100%; padding: 10px 12px; background: #0b1324; border: 1px solid #1e2a46; color: var(--text); border-radius: 10px; outline: none; transition: .12s ease; }
        input:focus { border-color: #2b4370; box-shadow: 0 0 0 4px rgba(104,168,255,.08); }
        button { padding: 10px 14px; border: 1px solid #2c3f63; background: linear-gradient(180deg, #12203d, #0d1831); color: var(--text); border-radius: 10px; cursor: pointer; transition: .12s ease; }
        button:hover { transform: translateY(-1px); border-color: #3b578a; box-shadow: 0 6px 16px rgba(20,48,92,.35); }
        .btn-accent { border-color: #3066a8; background: linear-gradient(180deg, #17305a, #13294e); }
        .btn-danger { border-color: #6b1c1c; background: linear-gradient(180deg, #3a1212, #2b0f0f); color: #fecaca; }
        .btn-ghost { background: transparent; border-color: transparent; color: var(--muted); }
        .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .split { display: grid; grid-template-columns: 1.2fr .8fr; gap: 16px; }
        .hidden { display: none; }
        .pill { padding: 4px 10px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: #0f182b; color: var(--muted); }
        .pill.ok { color: #86efac; border-color: #1c3b2b; background: #0c1a14; }
        .pill.warn { color: #fed7aa; border-color: #3b2f1c; background: #1a130c; }
        .list { display: grid; gap: 8px; }
        .list .item { display: grid; grid-template-columns: 1fr auto; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: #0b1324; }
        pre { background: #0a1120; padding: 12px; border-radius: 10px; border: 1px solid var(--border); color: #b9d1ff; max-height: 360px; overflow: auto; }
        .footer { text-align: center; color: var(--muted); padding: 16px; border-top: 1px solid var(--border); }
        .right { margin-left: auto; }
        @media (max-width: 960px) { .split { grid-template-columns: 1fr; } }
    </style>
    
</head>
<body>
    <header>
        <div class="container" style="display:flex; align-items:center; gap:16px;">
            <div class="brand">
                <div class="logo"></div>
                <h1>Library</h1>
            </div>
            <div class="right row">
                <span id="authStatus" class="pill">Signed out</span>
                <button id="logoutBtn" class="btn-ghost hidden">Logout</button>
            </div>
        </div>
        <div class="container" style="padding-top:0;">
            <div class="tabs" id="tabs">
                <button class="tab active" data-tab="tab-auth">Auth</button>
                <button class="tab" data-tab="tab-profile">Profile</button>
                <button class="tab" data-tab="tab-users">Users</button>
                <button class="tab" data-tab="tab-books">Books</button>
                <button class="tab" data-tab="tab-borrow">Borrow</button>
                <button class="tab" data-tab="tab-admin">Admin</button>
                <button class="tab" data-tab="tab-console">Console</button>
            </div>
        </div>
    </header>

    <main class="container shell">
        <section id="tab-auth">
            <div class="grid">
                <div class="card">
                    <h3>Login / Register</h3>
                    <label>Email</label>
                    <input id="email" type="email" placeholder="email" />
                    <label>Username <small>(only for register)</small></label>
                    <input id="username" type="text" placeholder="username" />
                    <label>Password</label>
                    <input id="password" type="password" placeholder="password" />
                    <div class="row">
                        <button id="register" class="btn-accent">Register</button>
                        <button id="login">Login</button>
                    </div>
                    <div class="row" style="margin-top:8px;align-items:center;gap:8px;">
                        <span class="muted">Token</span>
                        <code id="token" class="pill">(none)</code>
                        <button id="copyToken" class="btn-ghost">Copy</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-profile" class="hidden">
            <div class="grid">
                <div class="card">
                    <h3>My Profile</h3>
                    <div class="row">
                        <button id="btnProfile">GET /user/profile</button>
                    </div>
                    <div id="profileView" class="list" style="margin-top:12px"></div>
                </div>
            </div>
        </section>

        <section id="tab-users" class="hidden">
            <div class="grid">
                <div class="card">
                    <h3>Users</h3>
                    <div class="row">
                        <button id="getUsers">GET /user</button>
                    </div>
                    <div id="usersList" class="list" style="margin-top:12px"></div>
                </div>
            </div>
        </section>

        <section id="tab-books" class="hidden">
            <div class="split">
                <div class="card">
                    <h3>Publish a Book</h3>
                    <label>Name</label>
                    <input id="bookName" type="text" placeholder="Book name" />
                    <label>Pages</label>
                    <input id="bookPages" type="number" placeholder="Pages" />
                    <div class="row">
                        <button id="publish" class="btn-accent">Publish</button>
                        <button id="myBooks" class="">Load My Books</button>
                    </div>
                </div>
                <div class="card">
                    <h3>My Books</h3>
                    <div id="myBooksList" class="list"></div>
                </div>
            </div>
        </section>

        <section id="tab-borrow" class="hidden">
            <div class="split">
                <div class="card">
                    <h3>Borrow / Return</h3>
                    <label>Book ID</label>
                    <input id="bookId" type="text" placeholder="Mongo ID" />
                    <div class="row">
                        <button id="borrow">Borrow</button>
                        <button id="return">Return</button>
                        <button id="history">History</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Your Activity</h3>
                    <div class="row">
                        <button id="btnUserHistory">GET /book/user/history</button>
                        <button id="btnUserCurrent">GET /book/user/current</button>
                    </div>
                    <div id="userActivity" class="list" style="margin-top:12px"></div>
                </div>
            </div>
        </section>

        <section id="tab-admin" class="hidden">
            <div class="split">
                <div class="card">
                    <h3>Unpublished Books</h3>
                    <div class="row">
                        <button id="btnLoadUnpublished">GET /book/unpublished</button>
                    </div>
                    <div id="unpublishedList" class="list" style="margin-top:12px"></div>
                </div>
                <div class="card">
                    <h3>Publish / Unpublish by ID</h3>
                    <label>Book ID</label>
                    <input id="adminBookId" type="text" placeholder="Mongo ID" />
                    <div class="row">
                        <button id="btnPublishById">Publish</button>
                        <button id="btnUnpublishById">Unpublish</button>
                    </div>
                    <p class="muted">Note: Unpublish requires you to be the book author.</p>
                </div>
            </div>
        </section>

        <section id="tab-console" class="hidden">
            <div class="card">
                <h3>Console</h3>
                <pre id="output"></pre>
            </div>
        </section>
    </main>

    <footer class="footer">Built with ❤️ for your Library API</footer>

    <script>
        const $ = (id) => document.getElementById(id);
        const out = (data) => { const el = $('output'); if (!el) return; el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2); };
        let token = localStorage.getItem('token') || '';

        const headers = () => ({
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': 'Bearer ' + token } : {})
        });

        function setToken(newToken) {
            token = newToken || '';
            if (token) localStorage.setItem('token', token); else localStorage.removeItem('token');
            const t = $('token'); if (t) t.textContent = token ? token.slice(0, 20) + '...' : '(none)';
            updateAuthUi();
        }

        function updateAuthUi() {
            const status = $('authStatus');
            const logout = $('logoutBtn');
            if (token) {
                status.textContent = 'Signed in';
                status.classList.add('ok');
                status.classList.remove('warn');
                logout.classList.remove('hidden');
            } else {
                status.textContent = 'Signed out';
                status.classList.remove('ok');
                logout.classList.add('hidden');
            }
        }

        function activateTab(tabId) {
            document.querySelectorAll('.tab').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId));
            document.querySelectorAll('main section').forEach(sec => sec.classList.toggle('hidden', '#' + sec.id !== '#' + tabId));
        }

        document.getElementById('tabs').addEventListener('click', (e) => {
            const target = e.target.closest('.tab');
            if (!target) return;
            const tab = target.getAttribute('data-tab');
            activateTab(tab);
        });

        $('logoutBtn').onclick = () => setToken('');
        $('copyToken').onclick = async () => {
            try { await navigator.clipboard.writeText(token || ''); } catch {}
        };

        $('register').onclick = async () => {
            try {
                const res = await fetch('/user/register', {
                    method: 'POST',
                    headers: headers(),
                    body: JSON.stringify({
                        email: $('email').value,
                        username: $('username').value,
                        password: $('password').value
                    })
                });
                const data = await res.json();
                if (data.token) setToken(data.token);
                out(data);
            } catch (e) { out(String(e)); }
        };

        $('login').onclick = async () => {
            try {
                const res = await fetch('/user/login', {
                    method: 'POST',
                    headers: headers(),
                    body: JSON.stringify({
                        email: $('email').value,
                        password: $('password').value
                    })
                });
                const data = await res.json();
                if (data.token) setToken(data.token);
                out(data);
            } catch (e) { out(String(e)); }
        };

        // Profile
        $('btnProfile').onclick = async () => {
            try {
                const res = await fetch('/user/profile', { headers: headers() });
                const d = await res.json();
                out(d);
                const view = $('profileView');
                if (view && d && d.user) {
                    view.innerHTML = `
                        <div class="item"><div>Username</div><div class="pill">${d.user.username}</div></div>
                        <div class="item"><div>Email</div><div class="pill">${d.user.email}</div></div>
                        <div class="item"><div>ID</div><div class="pill">${d.user.id}</div></div>
                        <div class="item"><div>Created</div><div class="pill">${new Date(d.user.createdAt).toLocaleString()}</div></div>
                    `;
                }
            } catch (e) { out(String(e)); }
        };

        $('getUsers').onclick = async () => {
            try {
                const res = await fetch('/user', { headers: headers() });
                const d = await res.json();
                out(d);
                const list = $('usersList');
                if (list && d && d.users) {
                    list.innerHTML = d.users.map(u => `
                        <div class="item">
                            <div>
                                <div><strong>${u.username}</strong></div>
                                <div class="muted">${u.email}</div>
                                <div class="muted" style="font-size:12px">${u._id}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { out(String(e)); }
        };

        $('publish').onclick = async () => {
            try {
                const res = await fetch('/book/publish', {
                    method: 'POST',
                    headers: headers(),
                    body: JSON.stringify({
                        name: $('bookName').value,
                        pages: Number($('bookPages').value)
                    })
                });
                const d = await res.json();
                out(d);
                if (d && d.book) loadMyBooks();
            } catch (e) { out(String(e)); }
        };

        async function loadMyBooks() {
            try {
                const res = await fetch('/book/myBooks', { headers: headers() });
                const d = await res.json();
                out(d);
                const list = $('myBooksList');
                if (list && d && d.book) {
                    list.innerHTML = d.book.map(b => `
                        <div class="item">
                            <div>
                                <div><strong>${b.name}</strong> <span class="pill ${b.isPublished ? 'ok' : 'warn'}">${b.isPublished ? 'Published' : 'Unpublished'}</span></div>
                                <div class="muted">Pages: ${b.pages ?? '-'}</div>
                                <div class="muted" style="font-size:12px">${b._id}</div>
                            </div>
                            <div class="row">
                                <button data-act="edit" data-id="${b._id}">Update</button>
                                <button class="btn-danger" data-act="delete" data-id="${b._id}">Delete</button>
                                <button data-act="unpublish" data-id="${b._id}">Unpublish</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { out(String(e)); }
        }

        $('myBooks').onclick = loadMyBooks;

        $('myBooksList').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.getAttribute('data-id');
            const act = btn.getAttribute('data-act');
            if (act === 'delete') {
                try {
                    const res = await fetch(`/book/${encodeURIComponent(id)}`, { method: 'DELETE', headers: headers() });
                    const d = await res.json(); out(d); loadMyBooks();
                } catch (err) { out(String(err)); }
            } else if (act === 'edit') {
                const name = prompt('New name:');
                const pages = Number(prompt('New pages:'));
                try {
                    const res = await fetch(`/book/${encodeURIComponent(id)}`, { method: 'PUT', headers: headers(), body: JSON.stringify({ name, pages }) });
                    const d = await res.json(); out(d); loadMyBooks();
                } catch (err) { out(String(err)); }
            } else if (act === 'unpublish') {
                try {
                    const res = await fetch(`/book/unpublish/${encodeURIComponent(id)}`, { headers: headers() });
                    const d = await res.json(); out(d); loadMyBooks();
                } catch (err) { out(String(err)); }
            }
        });

        $('borrow').onclick = async () => {
            try {
                const id = $('bookId').value.trim();
                const res = await fetch(`/book/borrow/${encodeURIComponent(id)}`, {
                    method: 'POST',
                    headers: headers()
                });
                out(await res.json());
            } catch (e) { out(String(e)); }
        };

        $('return').onclick = async () => {
            try {
                const id = $('bookId').value.trim();
                const res = await fetch(`/book/return/${encodeURIComponent(id)}`, {
                    method: 'POST',
                    headers: headers()
                });
                out(await res.json());
            } catch (e) { out(String(e)); }
        };

        $('history').onclick = async () => {
            try {
                const id = $('bookId').value.trim();
                const res = await fetch(`/book/history/${encodeURIComponent(id)}`, {
                    headers: headers()
                });
                out(await res.json());
            } catch (e) { out(String(e)); }
        };

        // User history/current
        $('btnUserHistory').onclick = async () => {
            try {
                const res = await fetch('/book/user/history', { headers: headers() });
                const d = await res.json(); out(d);
                const list = $('userActivity');
                if (list && d && d.data) {
                    list.innerHTML = d.data.map(h => `
                        <div class="item">
                            <div>
                                <div>From: ${h.from ? new Date(h.from).toLocaleString() : '-'}</div>
                                <div>To: ${h.to ? new Date(h.to).toLocaleString() : '-'}</div>
                                <div class="muted" style="font-size:12px">${h._id}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { out(String(e)); }
        };

        $('btnUserCurrent').onclick = async () => {
            try {
                const res = await fetch('/book/user/current', { headers: headers() });
                const d = await res.json(); out(d);
                const list = $('userActivity');
                if (list && d && d.data) {
                    list.innerHTML = d.data.map(b => `
                        <div class="item"><div><strong>${b.name}</strong> <span class="pill">Borrowed</span><div class="muted" style="font-size:12px">${b._id}</div></div></div>
                    `).join('');
                }
            } catch (e) { out(String(e)); }
        };

        // Admin unpublished
        $('btnLoadUnpublished').onclick = async () => {
            try {
                const res = await fetch('/book/unpublished', { headers: headers() });
                const d = await res.json(); out(d);
                const list = $('unpublishedList');
                if (list && d && d.book) {
                    list.innerHTML = d.book.map(b => `
                        <div class="item">
                            <div>
                                <div><strong>${b.name}</strong> <span class="pill warn">Unpublished</span></div>
                                <div class="muted">Author: ${b.author ?? '-'}</div>
                                <div class="muted" style="font-size:12px">${b._id}</div>
                            </div>
                            <div class="row">
                                <button data-publish-id="${b._id}">Publish</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { out(String(e)); }
        };

        $('unpublishedList').addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-publish-id]');
            if (!btn) return;
            const id = btn.getAttribute('data-publish-id');
            try {
                const res = await fetch(`/book/unpublished/${encodeURIComponent(id)}`, { headers: headers() });
                const d = await res.json(); out(d);
                $('btnLoadUnpublished').click();
            } catch (err) { out(String(err)); }
        });

        $('btnPublishById').onclick = async () => {
            const id = $('adminBookId').value.trim();
            if (!id) return;
            try { const r = await fetch(`/book/unpublished/${encodeURIComponent(id)}`, { headers: headers() }); out(await r.json()); } catch (e) { out(String(e)); }
        };
        $('btnUnpublishById').onclick = async () => {
            const id = $('adminBookId').value.trim();
            if (!id) return;
            try { const r = await fetch(`/book/unpublish/${encodeURIComponent(id)}`, { headers: headers() }); out(await r.json()); } catch (e) { out(String(e)); }
        };

        // Initialize UI on load
        setToken(token);
        activateTab('tab-auth');
    </script>
</body>
</html>